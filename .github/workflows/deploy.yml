name: Deploy Docusaurus (Automated Test Server, Manual Production)

on:
  # 1. è‡ªåŠ¨è§¦å‘ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶
  push:
    branches:
      - main
      
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤º"Run workflow"æŒ‰é’®
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # =======================================================
  # JOB 1: è‡ªåŠ¨éƒ¨ç½²åˆ°å†…ç½‘æµ‹è¯•æœåŠ¡å™¨
  # æ­¤ Job ä»…åœ¨ push äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œ
  # =======================================================
  deploy_to_test_server:
    name: ğŸ§ª Deploy to Test Server (192.168.93.222:9000)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      # 0. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: 0. Display deployment info
        run: |
          echo "ğŸ§ª å¼€å§‹éƒ¨ç½²åˆ°å†…ç½‘æµ‹è¯•æœåŠ¡å™¨"
          echo "ğŸŒ ç›®æ ‡æœåŠ¡å™¨: 192.168.93.222:9000"
          echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: ${{ github.actor }}"
          echo "ğŸ”– æäº¤ SHA: ${{ github.sha }}"
          echo "ğŸ“… è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      # 1. æ£€å‡ºæºç 
      - name: 1. Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£… Node.jsï¼ˆå¹¶ç¼“å­˜ yarn ä¾èµ–ï¼‰
      - name: 2. Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: yarn

      # 3. å®‰è£…ä¾èµ–
      - name: 3. Install dependencies
        run: yarn install --frozen-lockfile

      # 4. æ„å»º Docusaurus é™æ€ç½‘ç«™ (å†…ç½‘æµ‹è¯•æœåŠ¡å™¨ç‰ˆæœ¬)
      - name: 4. Build website for Test Server
        env:
          NODE_ENV: production
          GITHUB_ACTIONS: true
          DEPLOY_ENV: test
          BASE_URL: /
          SITE_URL: http://42.194.138.11:3002
        run: yarn build

      # 5. ä½¿ç”¨ rsync éƒ¨ç½²åˆ°å†…ç½‘æµ‹è¯•æœåŠ¡å™¨
      - name: 5. Deploy to Test Server via SSH (rsync)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete
          path: ./build/
          remote_path: ${{ secrets.TARGET_PATH }}
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          
  # =======================================================
  # JOB 2: æ‰‹åŠ¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
  # æ­¤ Job ä»…åœ¨ workflow_dispatch (æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®) äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œ
  # =======================================================
  deploy_to_cloud_server:
    name: â˜ï¸ Deploy to Cloud Server (Manual)
    runs-on: ubuntu-latest
    # ä»…åœ¨ Actions é¡µé¢ç‚¹å‡»"Run workflow"æŒ‰é’®æ—¶è¿è¡Œï¼Œä¸”ç”¨æˆ·ç¡®è®¤éƒ¨ç½²
    if: github.event_name == 'workflow_dispatch'

    steps:
      # 0. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: 0. Display deployment info
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨"
          echo "ğŸ“ éƒ¨ç½²å¤‡æ³¨: ${{ github.event.inputs.deploy_note }}"
          echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: ${{ github.actor }}"
          echo "ğŸ”– æäº¤ SHA: ${{ github.sha }}"
          echo "ğŸ“… è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      # 1. æ£€å‡ºæºç  (æ‰‹åŠ¨è§¦å‘æ—¶ä¹Ÿéœ€è¦é‡æ–°æ£€å‡ºä»£ç )
      - name: 1. Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£… Node.jsï¼ˆå¹¶ç¼“å­˜ yarn ä¾èµ–ï¼‰
      - name: 2. Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: yarn

      # 3. å®‰è£…ä¾èµ–
      - name: 3. Install dependencies
        run: yarn install --frozen-lockfile

      # 4. æ„å»º Docusaurus é™æ€ç½‘ç«™ (ç”Ÿäº§æœåŠ¡å™¨ç‰ˆæœ¬)
      - name: 4. Build website for Production Server
        env:
          NODE_ENV: production
          GITHUB_ACTIONS: true
          DEPLOY_ENV: production
          BASE_URL: /
          SITE_URL: http://42.194.138.11:3002
        run: yarn build

      # 5. ä½¿ç”¨ rsync éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
      - name: 5. Deploy to Production Server via SSH (rsync)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete
          path: ./build/
          remote_path: ${{ secrets.TARGET_PATH }}
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}