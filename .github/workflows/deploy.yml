name: Deploy Docusaurus (Automated Pages, Manual Server)

on:
  # 1. è‡ªåŠ¨è§¦å‘ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶
  push:
    branches:
      - main
      
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤º"Run workflow"æŒ‰é’®
  workflow_dispatch:
    inputs:
      deploy_confirm:
        description: 'ğŸš€ ç¡®è®¤éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨'
        required: true
        type: choice
        options:
          - 'âœ… ç¡®è®¤éƒ¨ç½²'
          - 'âŒ å–æ¶ˆ'
        default: 'âŒ å–æ¶ˆ'
      deploy_note:
        description: 'ğŸ“ éƒ¨ç½²å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
        default: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²'

permissions:
  contents: write

jobs:
  # =======================================================
  # JOB 1: è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages
  # æ­¤ Job ä»…åœ¨ push äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œ
  # =======================================================
  deploy_to_github_pages:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      # 1. æ£€å‡ºæºç 
      - name: 1. Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£… Node.jsï¼ˆå¹¶ç¼“å­˜ yarn ä¾èµ–ï¼‰
      - name: 2. Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: yarn

      # 3. å®‰è£…ä¾èµ–
      - name: 3. Install dependencies
        run: yarn install --frozen-lockfile

      # 4. æ„å»º Docusaurus é™æ€ç½‘ç«™ (GitHub Pages ç‰ˆæœ¬)
      - name: 4. Build website for GitHub Pages
        env:
          NODE_ENV: production
          GITHUB_ACTIONS: true
          GITHUB_PAGES: true
          DEPLOY_ENV: github
          BASE_URL: /wiki-test/
          SITE_URL: https://zhenglingpeng.github.io
        run: yarn build

      # 5. éƒ¨ç½²åˆ° GitHub Pages
      - name: 5. Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: gh-pages
          user_name: GitHub Action
          user_email: action@github.com
          commit_message: |
            docs: deploy ${{ github.sha }} via GitHub Actions

  # =======================================================
  # JOB 2: æ‰‹åŠ¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
  # æ­¤ Job ä»…åœ¨ workflow_dispatch (æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®) äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œ
  # =======================================================
  deploy_to_cloud_server:
    name: â˜ï¸ Deploy to Cloud Server (Manual)
    runs-on: ubuntu-latest
    # ä»…åœ¨ Actions é¡µé¢ç‚¹å‡»"Run workflow"æŒ‰é’®æ—¶è¿è¡Œï¼Œä¸”ç”¨æˆ·ç¡®è®¤éƒ¨ç½²
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_confirm == 'âœ… ç¡®è®¤éƒ¨ç½²'

    steps:
      # 0. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: 0. Display deployment info
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨"
          echo "ğŸ“ éƒ¨ç½²å¤‡æ³¨: ${{ github.event.inputs.deploy_note }}"
          echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: ${{ github.actor }}"
          echo "ğŸ”– æäº¤ SHA: ${{ github.sha }}"
          echo "ğŸ“… è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      # 1. æ£€å‡ºæºç  (æ‰‹åŠ¨è§¦å‘æ—¶ä¹Ÿéœ€è¦é‡æ–°æ£€å‡ºä»£ç )
      - name: 1. Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£… Node.jsï¼ˆå¹¶ç¼“å­˜ yarn ä¾èµ–ï¼‰
      - name: 2. Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: yarn

      # 3. å®‰è£…ä¾èµ–
      - name: 3. Install dependencies
        run: yarn install --frozen-lockfile

      # 6. æ„å»º Docusaurus é™æ€ç½‘ç«™ (æœåŠ¡å™¨ç‰ˆæœ¬)
      - name: 6. Build website for Cloud Server
        env:
          NODE_ENV: production
          GITHUB_ACTIONS: true
          GITHUB_PAGES: false
          DEPLOY_ENV: production
          BASE_URL: /
          SITE_URL: http://42.194.138.11:3002
        run: yarn build

      # 7. ä½¿ç”¨ rsync éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
      - name: 7. Deploy to Cloud Server via SSH (rsync)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete
          path: ./build/
          remote_path: ${{ secrets.TARGET_PATH }}
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}